default:
  tags: [ basic, gridpack, ikp, k8s ]
  artifacts:
    when: always
    untracked: true


stages: [ build-container, build-gridpack, test-gridpack ]


variables:
  MAKE_JOBS: "2"


check-container-definition-changed:
  image: alpine
  script:
    - touch container-definition-changed
  rules:
    - if: $CI_PIPELINE_SOURCE == "push"
      changes: [ "build/**/*" ]


# https://docs.gitlab.com/ee/ci/docker/using_kaniko.html#building-an-image-with-kaniko-behind-a-proxy
.build-container:
  stage: build-container
  timeout: 5 hours
  image:
    name: gcr.io/kaniko-project/executor:v1.9.0-debug
    entrypoint: [""]
  needs: [ check-container-definition-changed ]
  script:
    - local force_build="false"
    - test -f container-definition-changed && force_build="true"
    - . ./build/lib.sh
    - check_build_container "${BASE_IMAGE}" "${force_build}" > build.log 2>&1


build-container:ubuntu:
  extends: .build-container
  variables:
    BASE_IMAGE: ubuntu:22.04


.build-gridpack:
  stage: build-gridpack
  script:
    - /bin/bash ./build/install_gridpack.sh


build-gridpack:ubuntu:
  extends: .build-gridpack
  image: ${CI_REGISTRY_IMAGE}:ubuntu-gridpack-env
  needs:
    - job: build-container:ubuntu
      optional: true


.test-gridpack:
  stage: test-gridpack
  script:
    - useradd gridpack
    - chown -R gridpack:gridpack .
    - su gridpack -c 'ctest --test-dir src/build --output-on-failure'
  artifacts:
    paths: [ src/build/Testing/Temporary ]


test-gridpack:ubuntu:
  extends: .test-gridpack
  image: ${CI_REGISTRY_IMAGE}:ubuntu-gridpack-env
  needs: [ build-gridpack:ubuntu ]
