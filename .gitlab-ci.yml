default:
  tags: [ basic, gridpack, ikp, k8s ]
  artifacts:
    when: always
    untracked: true

stages: [ build-container, build-gridpack, test-gridpack ]


variables:
  KUBERNETES_CPU_REQUEST: "1"
  KUBERNETES_CPU_LIMIT: "2"
  KUBERNETES_MEMORY_REQUEST: "4Gi"
  KUBERNETES_MEMORY_LIMIT: "8Gi"
  http_proxy: "http://proxy01.pnl.gov:3128"
  https_proxy: ${http_proxy}


# https://docs.gitlab.com/ee/ci/docker/using_kaniko.html#building-an-image-with-kaniko-behind-a-proxy
.build-container:
  stage: build-container
  timeout: 5 hours
  image:
    name: gcr.io/kaniko-project/executor:v1.9.0-debug
    entrypoint: [""]
  variables:
    IMAGE_PATH: ${CI_REGISTRY_IMAGE}:${BASE_IMAGE}-gridpack-env
  script:
    - chmod +x *.sh
    - >
      /kaniko/executor
      --context "${CI_PROJECT_DIR}"
      --build-arg "BASE_IMAGE=${BASE_IMAGE}:${BASE_IMAGE_TAG}"
      --build-arg "http_proxy=$http_proxy"
      --build-arg "https_proxy=$https_proxy"
      --dockerfile "${CI_PROJECT_DIR}/dockerfile"
      --destination "${IMAGE_PATH}" > build.log 2>&1
  # disabled for troubleshooting
  # rules:
    # - if: $CI_PIPELINE_SOURCE == "push"
    #   changes: [ "dockerfile", "install_environment_packages.sh", "install_gridpack_deps.sh" ]


# disabled for troubleshooting
.build-container:ubuntu:
  extends: .build-container
  variables:
    BASE_IMAGE: ubuntu
    BASE_IMAGE_TAG: "22.04"


build-container:rockylinux:
  extends: .build-container
  variables:
    BASE_IMAGE: rockylinux
    BASE_IMAGE_TAG: "9"


.build-gridpack:
  stage: build-gridpack
  variables:
    MAKE_JOBS: "2"
  script:
    - ./install_gridpack.sh


# disabled for troubleshooting
.build-gridpack:ubuntu:
  extends: .build-gridpack
  image: ${CI_REGISTRY_IMAGE}:ubuntu-gridpack-env
  needs:
    - job: build-container:ubuntu
      optional: true


build-gridpack:rockylinux:
  extends: .build-gridpack
  image: ${CI_REGISTRY_IMAGE}:rockylinux-gridpack-env
  needs:
    - job: build-container:rockylinux
      optional: true


.test-gridpack:
  stage: test-gridpack
  script:
    - useradd gridpack
    - chown -R gridpack:gridpack .
    - su gridpack -c 'ctest --test-dir src/build --output-on-failure'
  artifacts:
    paths: [ src/build/Testing/Temporary ]


# disabled for troubleshooting
. test-gridpack:ubuntu:
  extends: .test-gridpack
  image: ${CI_REGISTRY_IMAGE}:ubuntu-gridpack-env
  needs: [ build-gridpack:ubuntu ]


test-gridpack:rockylinux:
  extends: .test-gridpack
  image: ${CI_REGISTRY_IMAGE}:rockylinux-gridpack-env
  needs: [ build-gridpack:rockylinux ]
