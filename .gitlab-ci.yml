default:
  tags: [basic, gridpack, ikp, k8s]
  artifacts:
    when: always
    untracked: true
  image: ubuntu:22.04

stages: [check-container, build-container, build-gridpack, test-gridpack]

variables:
  MAKE_JOBS: "2"
  UBUNTU_BASE_IMAGE: "ubuntu:22.04"
  UBUNTU_ENV_IMAGE: "ubuntu-gridpack-env"
  ROCKY_BASE_IMAGE: "rockylinux:9"
  ROCKY_ENV_IMAGE: "rocky-gridpack-env"

check-container-definition-changed:
  stage: check-container
  script:
    - touch container-definition-changed
  rules:
    - if: $CI_PIPELINE_SOURCE == "push"
      changes: ["build/**/*"]

.check-container-needs-built:
  stage: check-container
  needs:
    - job: check-container-definition-changed
      optional: true
  script:
    - set -o xtrace -o errexit -o nounset -o pipefail
    - apt-get update && apt-get install -y curl jq
    - source ./build/container_lib.sh
    - check_container_needs_built "${BASE_IMAGE}"

check-container-needs-built:ubuntu:
  extends: .check-container-needs-built
  variables:
    BASE_IMAGE: ${UBUNTU_BASE_IMAGE}

# https://docs.gitlab.com/ee/ci/docker/using_kaniko.html#building-an-image-with-kaniko-behind-a-proxy
.build-container:
  stage: build-container
  timeout: 5 hours
  image:
    name: gcr.io/kaniko-project/executor:v1.9.0-debug
    entrypoint: [""]
  script:
    - source ./build/container_lib.sh
    - test -f container-definition-changed &&
      build_container "${BASE_IMAGE}" > build.log 2>&1

build-container:ubuntu:
  extends: .build-container
  needs: [check-container-needs-built:ubuntu]
  variables:
    BASE_IMAGE: ${UBUNTU_BASE_IMAGE}

.build-gridpack:
  stage: build-gridpack
  script:
    - /bin/bash ./build/install_gridpack.sh

build-gridpack:ubuntu:
  extends: .build-gridpack
  image: ${CI_REGISTRY_IMAGE}:${UBUNTU_ENV_IMAGE}
  needs: [build-container:ubuntu]

.test-gridpack:
  stage: test-gridpack
  script:
    # load mpi module if on RHEL
    - source ./build/install_package_deps_lib.sh
    - load_mpi_module

    # run tests
    - ctest --test-dir src/build --output-on-failure
  artifacts:
    paths: [src/build/Testing/Temporary]

test-gridpack:ubuntu:
  extends: .test-gridpack
  image: ${CI_REGISTRY_IMAGE}:${UBUNTU_ENV_IMAGE}
  needs: [build-gridpack:ubuntu]
