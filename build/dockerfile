ARG BASE_IMAGE
FROM ${BASE_IMAGE}

SHELL ["/bin/bash", "-c"]

ARG http_proxy
ARG https_proxy

ENV GP_EXT_DEPS=/gridpack-dependencies
ENV HTTP_PROXY=${http_proxy} \
  HTTPS_PROXY=${https_proxy} \
  OMPI_ALLOW_RUN_AS_ROOT="1" \
  OMPI_ALLOW_RUN_AS_ROOT_CONFIRM="1" \
  LD_LIBRARY_PATH="${GP_EXT_DEPS}/boost/install_for_gridpack/lib:${GP_EXT_DEPS}/ga/install_for_gridpack/lib:${GP_EXT_DEPS}/petsc/install_for_gridpack/lib"

WORKDIR ${GP_EXT_DEPS}
RUN mkdir logs

COPY install_package_deps_lib.sh ./
RUN set -xeuo pipefail \
  && source ./install_package_deps_lib.sh \
  && install_packages 2>&1 | tee logs/install_packages.log

COPY install_boost.sh ./
RUN set -xeuo pipefail && bash ./install_boost.sh 2>&1 | tee logs/install_boost.log

COPY install_ga.sh ./
RUN set -xeuo pipefail && bash ./install_ga.sh 2>&1 | tee logs/install_ga.log

COPY install_petsc.sh ./
RUN set -xeuo pipefail && bash ./install_petsc.sh 2>&1 | tee logs/install_petsc.log

RUN rm *.sh
